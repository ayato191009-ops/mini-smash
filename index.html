<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>スマブラ風ゲーム 完全版</title>
<style>
canvas{ background:#333; display:block; margin:0 auto; }
#stick {
  position:fixed; bottom:20px; left:20px;
  width:160px; height:160px;
  border-radius:50%;
  background:rgba(200,200,200,0.3);
}
#jump {
  position:fixed; bottom:140px; right:30px;
  width:96px; height:96px;
  border-radius:50%;
  font-size:24px;
  opacity:0.8;
}
#attackA, #attackB {
  position:fixed;
  width:80px; height:80px;
  border-radius:50%;
  font-size:20px;
  opacity:0.8;
}
#attackA { bottom:60px; right:30px; }
#attackB { bottom:60px; right:120px; }
</style>
</head>
<body>
<canvas id="game" width="480" height="320"></canvas>

<div id="stick"></div>
<button id="jump">⬆</button>
<button id="attackA">A</button>
<button id="attackB">B</button>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

// --- キャラクター ---
class Player{
  constructor(x,y,color){
    this.x=x; this.y=y; this.spawnX=x; this.spawnY=y;
    this.vx=0; this.vy=0;
    this.w=40; this.h=80; // 大きめサイズ
    this.color=color;
    this.damage=0;
    this.jumpCount=0;
    this.state="idle";
    this.attackType="weak";
    this.attackTimer=0;
    this.isCPU=false;
  }

  update(target){
    if(!this.isCPU) this.x+=this.vx;
    this.vy +=0.6;
    this.y +=this.vy;

    // 足場
    platforms.forEach(p=>{
      if(this.vy>=0 && this.x+this.w>p.x && this.x<p.x+p.w &&
         this.y+this.h>=p.y && this.y+this.h<=p.y+p.h+10){
           this.y=p.y-this.h;
           this.vy=0;
           this.jumpCount=0;
      }
    });

    // 場外判定（上、下、左右）
    if(this.y+this.h>canvas.height || this.x+this.w<0 || this.x>canvas.width || this.y<-this.h){
      this.respawn();
    }

    // 攻撃タイマー
    if(this.attackTimer>0) this.attackTimer--;
    
    if(target) this.attackHit(target);
  }

  respawn(){
    this.x=this.spawnX; this.y=this.spawnY;
    this.vx=0; this.vy=0; this.damage=0; this.jumpCount=0;
    this.state="idle";
  }

  attackHit(target){
    if(this.state!=="attack") return;
    let rangeX=28, rangeY=40;
    let offsetX=0;
    if(this.attackType==="forward") offsetX=this.w/2+10;
    else if(this.attackType==="air") offsetX=0;
    else if(this.attackType==="down") offsetX=0;
    else offsetX=this.w/2;
    const direction = this.vx>=0?1:-1;
    const attackX = this.x+this.w/2 + offsetX*direction;
    const attackY = this.y+this.h/2;
    const dx = attackX-(target.x+target.w/2);
    const dy = attackY-(target.y+target.h/2);
    if(Math.abs(dx)<rangeX && Math.abs(dy)<rangeY){
      let dmg=0,vx=0,vy=0;
      if(this.attackType==="air"){ dmg=8; vx=(dx>0?-4:4)*(1+target.damage*0.03); vy=-5;}
      else if(this.attackType==="down"){ dmg=10; vx=0; vy=6;}
      else{ dmg=12; vx=(dx>0?-6:6)*(1+target.damage*0.03); vy=-4;}
      target.damage += dmg;
      target.vx=vx;
      target.vy=vy;
    }
  }

  draw(){
    ctx.fillStyle=this.state==="attack"?"red":this.color;
    ctx.fillRect(this.x,this.y,this.w,this.h); //胴体
    ctx.fillRect(this.x+8,this.y-20,this.w-16,20); //頭
    ctx.fillRect(this.x-8,this.y+8,8,this.h-16); //手
    ctx.fillRect(this.x+this.w,this.y+8,8,this.h-16);
    ctx.fillRect(this.x+8,this.y+this.h,12,16); //足
    ctx.fillRect(this.x+this.w-20,this.y+this.h,12,16);
    ctx.fillStyle="white";
    ctx.font="14px sans-serif";
    ctx.fillText(this.isCPU?"CPU":"P", this.x, this.y-25);
  }
}

// --- CPU ---
class CPU extends Player{
  constructor(x,y,color){
    super(x,y,color);
    this.isCPU=true;
    this.aiTimer=0;
  }

  update(player){
    this.aiTimer--;
    if(this.aiTimer<=0){
      this.aiTimer=30+Math.random()*40;
      const dx = player.x - this.x;
      this.vx = Math.abs(dx)>50 ? (dx>0?2:-2):0;
      if(Math.random()<0.3 && this.jumpCount<2) this.vy=-10;
      if(this.state==="idle"){
        if(Math.abs(dx)<40){ 
          this.state="attack"; 
          this.attackType=Math.random()<0.5?"weak":"air"; 
          this.attackTimer=this.attackType==="weak"?14:16; 
        } else if(Math.abs(dx)<120){ 
          this.state="attack"; 
          this.attackType="forward"; 
          this.attackTimer=24; 
        }
      }
    }
    super.update(player);
  }
}

// --- ステージ ---
const platforms=[{x:0,y:200,w:480,h:20}];

// --- インスタンス ---
const player = new Player(80,150,"cyan");
const cpu = new CPU(260,150,"orange");

// --- スティック ---
const stick=document.getElementById("stick");
let stickTouchId=null;
let stickDir={x:0};

stick.addEventListener("touchstart", e=>{
  const t = e.changedTouches[0]; stickTouchId=t.identifier; updateStickDir(t);
},{passive:false});
stick.addEventListener("touchmove", e=>{
  for(const t of e.changedTouches) if(t.identifier===stickTouchId) updateStickDir(t);
},{passive:false});
stick.addEventListener("touchend", e=>{
  for(const t of e.changedTouches) if(t.identifier===stickTouchId) stickTouchId=null, stickDir.x=0;
},{passive:false});

function updateStickDir(t){
  const rect=stick.getBoundingClientRect();
  const cx=rect.left+rect.width/2;
  const dx=t.clientX-cx;
  const maxDist=rect.width/2;
  stickDir.x=Math.max(-1, Math.min(1, dx/maxDist));
}

// --- ジャンプ ---
const jumpBtn=document.getElementById("jump");
jumpBtn.addEventListener("touchstart", e=>{
  e.preventDefault();
  if(player.jumpCount<2){ player.vy=-10; player.jumpCount++; }
},{passive:false});

// --- 攻撃 ---
document.getElementById("attackA").addEventListener("touchstart", e=>{
  e.preventDefault();
  if(player.state==="idle"){
    player.state="attack";
    player.attackType="weak";
    player.attackTimer=14;
  }
},{passive:false});

document.getElementById("attackB").addEventListener("touchstart", e=>{
  e.preventDefault();
  if(player.state==="idle"){
    player.state="attack";
    player.attackType="forward";
    player.attackTimer=24;
  }
},{passive:false});

// --- ゲームループ ---
function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#555"; ctx.fillRect(0,200,canvas.width,120);

  player.vx=stickDir.x*3;
  player.update(cpu);
  cpu.update(player);

  player.draw();
  cpu.draw();

  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
