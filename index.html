<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>スマブラ風ゲーム（完全版）</title>
<style>
canvas{ background:#333; display:block; margin:0 auto; }
#stick {
  position:fixed; bottom:20px; left:20px;
  width:120px; height:120px;
  border-radius:50%;
  background:rgba(200,200,200,0.3);
}
#jump {
  position:fixed; bottom:150px; right:40px;
  width:64px; height:64px;
  border-radius:50%;
  font-size:18px;
  opacity:0.8;
}
</style>
</head>
<body>
<canvas id="game" width="480" height="320"></canvas>
<div id="stick"></div>
<button id="jump">⬆</button>
<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

// --- キャラクタークラス ---
class Player{
  constructor(x,y,color){
    this.x=x; this.y=y; this.spawnX=x; this.spawnY=y;
    this.vx=0; this.vy=0;
    this.w=20; this.h=40;
    this.color=color;
    this.damage=0;
    this.jumpCount=0;
    this.state="idle";
    this.attackType="weak";
    this.attackTimer=0;
    this.isCPU=false;
  }

  update(target){
    // 移動
    if(!this.isCPU) this.x += this.vx;
    
    // 重力
    this.vy +=0.6;
    this.y += this.vy;

    // 足場
    platforms.forEach(p=>{
      if(this.vy>=0 && this.x+this.w>p.x && this.x<p.x+p.w &&
         this.y+this.h>=p.y && this.y+this.h<=p.y+p.h+10){
           this.y=p.y-this.h;
           this.vy=0;
           this.jumpCount=0;
      }
    });

    // 地面
    if(this.y+this.h>200){
      this.y=200-this.h;
      this.vy=0;
      this.jumpCount=0;
    }

    // 場外判定
    if(this.y+this.h>canvas.height || this.x+this.w<0 || this.x>canvas.width){
      this.respawn();
    }

    // 攻撃タイマー
    if(this.attackTimer>0) this.attackTimer--;

    // 攻撃判定
    if(target) this.attackHit(target);
  }

  respawn(){
    this.x=this.spawnX; this.y=this.spawnY;
    this.vx=0; this.vy=0; this.damage=0; this.jumpCount=0;
    this.state="idle";
  }

  attackHit(target){
    if(this.state!=="attack") return;
    let rangeX=28, rangeY=40;
    let offsetX=0;
    if(this.attackType==="forward") offsetX=this.w/2+10;
    else if(this.attackType==="air") offsetX=0;
    else if(this.attackType==="down") offsetX=0;
    else offsetX=this.w/2;
    const direction = this.vx>=0?1:-1;
    const attackX = this.x+this.w/2 + offsetX*direction;
    const attackY = this.y+this.h/2;
    const dx = attackX-(target.x+target.w/2);
    const dy = attackY-(target.y+target.h/2);
    if(Math.abs(dx)<rangeX && Math.abs(dy)<rangeY){
      let dmg=0,vx=0,vy=0;
      if(this.attackType==="air"){ dmg=8; vx=dx>0?-2:2; vy=-8;}
      else if(this.attackType==="down"){ dmg=10; vx=0; vy=8;}
      else{ dmg=12; vx=dx>0?-6:6; vy=-4;}
      target.damage += dmg;
      const k = 1+target.damage*0.03;
      target.vx = vx*k; target.vy = vy*k;
    }
  }

  draw(){
    ctx.fillStyle=this.state==="attack"?"red":this.color;
    ctx.fillRect(this.x,this.y,this.w,this.h); //胴体
    ctx.fillRect(this.x+4,this.y-10,this.w-8,10); //頭
    ctx.fillRect(this.x-4,this.y+4,4,this.h-8); //手
    ctx.fillRect(this.x+this.w,this.y+4,4,this.h-8);
    ctx.fillRect(this.x+4,this.y+this.h,6,8); //足
    ctx.fillRect(this.x+this.w-10,this.y+this.h,6,8);
    ctx.fillStyle="white";
    ctx.font="12px sans-serif";
    ctx.fillText(this.isCPU?"CPU":"P", this.x, this.y-15);
  }
}

// --- CPUクラス ---
class CPU extends Player{
  constructor(x,y,color){
    super(x,y,color);
    this.isCPU=true;
    this.aiTimer=0;
  }

  update(player){
    this.aiTimer--;
    if(this.aiTimer<=0){
      this.aiTimer=30+Math.random()*40;
      const dx = player.x - this.x;
      this.vx = Math.abs(dx)>50 ? (dx>0?2:-2):0;
      if(Math.random()<0.3 && this.jumpCount<2) this.vy=-10;
      if(this.state==="idle"){
        if(Math.abs(dx)<40){ 
          this.state="attack"; 
          this.attackType=Math.random()<0.5?"weak":"air"; 
          this.attackTimer=this.attackType==="weak"?14:16; 
        } else if(Math.abs(dx)<120){ 
          this.state="attack"; 
          this.attackType="forward"; 
          this.attackTimer=24; 
        }
      }
    }
    super.update(player);
  }
}

// --- ステージ ---
const platforms=[{x:0,y:200,w:480,h:20}];

// --- インスタンス ---
const player = new Player(80,150,"cyan");
const cpu = new CPU(260,150,"orange");

// --- スティック操作 ---
const stick=document.getElementById("stick");
let stickTouchId=null;
let stickDir={x:0};

stick.addEventListener("touchstart", e=>{
  const t = e.changedTouches[0]; stickTouchId=t.identifier; updateStickDir(t);
},{passive:false});
stick.addEventListener("touchmove", e=>{
  for(const t of e.changedTouches) if(t.identifier===stickTouchId) updateStickDir(t);
},{passive:false});
stick.addEventListener("touchend", e=>{
  for(const t of e.changedTouches) if(t.identifier===stickTouchId) stickTouchId=null, stickDir.x=0;
},{passive:false});

function updateStickDir(t){
  const rect=stick.getBoundingClientRect();
  const cx=rect.left+rect.width/2;
  const dx=t.clientX-cx;
  const maxDist=rect.width/2;
  stickDir.x=Math.max(-1, Math.min(1, dx/maxDist));
}

// --- ジャンプボタン ---
const jumpBtn = document.getElementById("jump");
jumpBtn.addEventListener("touchstart", e=>{
  e.preventDefault();
  if(player.jumpCount<2){ player.vy=-10; player.jumpCount++; }
},{passive:false});
jumpBtn.addEventListener("touchend", e=>{ e.preventDefault(); });
jumpBtn.addEventListener("touchcancel", e=>{ e.preventDefault(); });

// --- ゲームループ ---
function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // 背景
  ctx.fillStyle="#555";
  ctx.fillRect(0,200,canvas.width,120);

  // 更新
  player.vx=stickDir.x*3; // 左右移動
  player.update(cpu);
  cpu.update(player);

  // 描画
  player.draw();
  cpu.draw();

  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
