<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Mini Smash</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { margin:0; overflow:hidden; background:#111; }
canvas { display:block; background:#87ceeb; touch-action:none; }
</style>
</head>
<body>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();
addEventListener("resize", resize);

const GRAVITY = 0.7;
const GROUND = () => canvas.height - 80;

function createFighter(x,color,isCPU=false){
  return {
    x,y:200,
    vx:0,vy:0,
    dir:1,
    jumps:2,
    hp:0,
    attacking:false,
    attackType:0,
    attackTimer:0,
    alive:true,
    color,
    isCPU
  };
}

const player = createFighter(150,"white");
const cpu = createFighter(400,"red",true);

let input = {left:false,right:false,jump:false,attack:false,strong:false};

canvas.addEventListener("touchstart",e=>{
  const t=e.touches[0];
  const x=t.clientX, y=t.clientY;
  if(y < canvas.height*0.3) input.jump=true;
  else if(y > canvas.height*0.7) {
    input.attack=true;
    input.attackStart=Date.now();
  }
  else if(x < canvas.width/2) input.left=true;
  else input.right=true;
});

canvas.addEventListener("touchend",()=>{
  if(input.attack){
    input.strong = Date.now()-input.attackStart>400;
  }
  input.left=input.right=input.jump=input.attack=false;
});

function reset(f){
  f.x = f.isCPU ? canvas.width-150 : 150;
  f.y = 200;
  f.vx = f.vy = 0;
  f.jumps = 2;
  f.hp = 0;
  f.alive = true;
}

function drawHuman(f){
  ctx.strokeStyle=f.color;
  ctx.fillStyle=f.color;
  ctx.lineWidth=4;

  // 頭
  ctx.beginPath();
  ctx.arc(f.x, f.y-40, 14, 0, Math.PI*2);
  ctx.fill();

  // 胴
  ctx.beginPath();
  ctx.moveTo(f.x, f.y-25);
  ctx.lineTo(f.x, f.y+25);
  ctx.stroke();

  // 腕（攻撃モーション）
  let ax = f.attacking ? 30*f.dir : 20*f.dir;
  ctx.beginPath();
  ctx.moveTo(f.x, f.y-10);
  ctx.lineTo(f.x+ax, f.y);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(f.x, f.y-10);
  ctx.lineTo(f.x-15*f.dir, f.y);
  ctx.stroke();

  // 脚
  ctx.beginPath();
  ctx.moveTo(f.x, f.y+25);
  ctx.lineTo(f.x-12, f.y+55);
  ctx.moveTo(f.x, f.y+25);
  ctx.lineTo(f.x+12, f.y+55);
  ctx.stroke();
}

function attackHit(attacker, target){
  const range = attacker.attackType===2 ? 60 : 40;
  const dx = (attacker.x + attacker.dir*range) - target.x;
  const dy = attacker.y - target.y;
  if(Math.abs(dx)<25 && Math.abs(dy)<40){
    target.vx += attacker.dir * (attacker.attackType===2?10:6);
    target.vy -= attacker.attackType===2?8:5;
    target.hp += attacker.attackType===2?15:8;
  }
}

function updateFighter(f, enemy){
  if(!f.alive) return;

  if(!f.isCPU){
    if(input.left){ f.vx=-4; f.dir=-1; }
    else if(input.right){ f.vx=4; f.dir=1; }
    else f.vx*=0.7;

    if(input.jump && f.jumps>0){
      f.vy=-13;
      f.jumps--;
      input.jump=false;
    }

    if(input.strong){
      f.attacking=true;
      f.attackType=2;
      f.attackTimer=15;
      attackHit(f,enemy);
      input.strong=false;
    }
    else if(input.attack){
      f.attacking=true;
      f.attackType=1;
      f.attackTimer=10;
      attackHit(f,enemy);
    }
  } else {
    // CPU AI
    if(enemy.x < f.x-10){ f.vx=-3; f.dir=-1; }
    else if(enemy.x > f.x+10){ f.vx=3; f.dir=1; }
    if(Math.random()<0.01 && f.jumps>0){
      f.vy=-12; f.jumps--;
    }
    if(Math.abs(enemy.x-f.x)<50 && !f.attacking){
      f.attacking=true;
      f.attackType=1;
      f.attackTimer=10;
      attackHit(f,enemy);
    }
  }

  f.vy += GRAVITY;
  f.x += f.vx;
  f.y += f.vy;

  if(f.y > GROUND()-55){
    f.y = GROUND()-55;
    f.vy = 0;
    f.jumps = 2;
  }

  if(f.attacking){
    f.attackTimer--;
    if(f.attackTimer<=0) f.attacking=false;
  }

  if(f.y > canvas.height+100 || f.x < -100 || f.x > canvas.width+100){
    f.alive=false;
    setTimeout(()=>reset(f),1000);
  }
}

function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // ステージ
  ctx.fillStyle="#654321";
  ctx.fillRect(0,GROUND(),canvas.width,80);

  updateFighter(player,cpu);
  updateFighter(cpu,player);

  if(player.alive) drawHuman(player);
  if(cpu.alive) drawHuman(cpu);

  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
